---
title:  国际手机号（区号选择）在项目中使用
tags: Eric的博客
author: Eric
date: 2023-7-9
comments: false
cover: /img/8.jpg
index_enable: true #是否显示文章封面
aside_enable: true #侧栏是否显示文章封面图s
archives_enable: true 
position: both #封面显示的位置# 三个值可配置left , right , both 
---

# 前言

公司做物流运输项目中牵扯到国际手机号适配问题，需用到选择国际手机区号问题，在网上查询找到基于谷歌开源的二次封装的一个组件-[vue-countryintl](https://github.com/941477276/vue-country-intl/blob/master/README-CN.md)

# 使用

1. 安装

   ```js
   npm install vue-country-intl --save
   ```

2. 使用----.vue单文件

  ```js
      /*****main.js****/
    import VueCountryIntl from 'vue-country-intl';
    // 引入css
    import 'vue-country-intl/lib/vue-country-intl.css'
    // 全局注册组件
    Vue.component(VueCountryIntl.name, VueCountryIntl);

    /*****组件中使用****/
    <template>
        <vue-country-intl v-model="countryCode"></vue-country-intl>
    </template>
  ```

3. 使用---直接引入js文件

  ```js
  <link rel="stylesheet" href="./lib/vue-country-intl.css">
  <script src="./lib/vue-country-intl.min.js"></script>
  <script>
    Vue.component('vue-country-intl', vueCountryIntl);
    new Vue({
      el: '#app',
      data: {}
    });  
  ```

4. schema=input(默认)

  ```js
  <template>
    <VueCountryIntl v-model="phoneCountry"></VueCountryIntl>
  </template>   
  ```
  
5. 其他配置参考官方文档

# 项目中基于原有form组件进行二次封装

1. 新建一个组件internationalPhone.vue

```html
<template>
  <div class="rpl-flex rpl-w-full">
    <div class="rpl-flex-1">
      <el-input ref="phoneRef" @input="inputHandle" @clear="inputHandle" class="phone-input input-with-select"
        :class="item.radius ? 'boder-phone-input-' + item.radius : ''" v-model.trim="fieldForm[item.fieldName]"
        :disabled="disabled" :maxlength="item.maxlength || 50" :placeholder="item.placeholder" :type="item.formType"
        clearable>
        <template #prepend>
          <div :class="item.size ? 'vue-country-intl-input-' + item.size : 'vue-country-intl-input-small'">
            <vue3-country-intl :disabled="disabled" :iso2="fieldForm[item.fieldCountry]" v-model="dialCode"
              :placeholder="'请选择国家或地区'" :useChinese="true" :onlyValue="true" :showSelectedText="false"
              @on-change="changeCount" v-bind="$attrs"></vue3-country-intl>
          </div>
        </template>
      </el-input>
    </div>
  </div>
</template>
<script>
export default {
  inheritAttrs: false,
};
</script>
<script setup>
import {
  reactive,
  ref,
  toRefs,
  onMounted,
  getCurrentInstance,
  watch,
  nextTick,
} from "vue";
import Vue3CountryIntl from "vue3-country-intl";
import parsePhoneNumber from "libphonenumber-js";
// 引入css
import "vue3-country-intl/lib/vue3-country-intl.css";
const props = defineProps({
  fieldForm: {
    // 表单数据
    type: Object,
    default: () => { },
  },
  item: {
    // 表单单项配置
    type: Object,
    default: () => { },
  },
  disabled: {
    type: Boolean,
    default: false,
  },
});
const emits = defineEmits(["phoneHandle"]);
// 区号 默认为+86
const dialCode = ref("");
const phoneRef = ref(null);
function changeCount(data, type) {
  // 国家code赋值
  console.log('daaaaaa', data);
  console.log('props.fieldForm', props.fieldForm)
  props.fieldForm[props.item.fieldCountry] = data.iso2;
  // 区号赋值
  dialCode.value = "+" + data.dialCode;
  console.log("changeCount", arguments);
  const emitsPhone = getPhoneData();

  if (type !== 'init') {
    phoneRef.value.focus();
    nextTick(() => {
      phoneRef.value.blur();
    })
    emits("phoneHandle", emitsPhone);
  }
}
function inputHandle() {
  const emitsPhone = getPhoneData();
  console.log('====================================');
  console.log(emitsPhone);
  console.log('====================================');
  emits("phoneHandle", emitsPhone);
}
// 获取手机号数据
function getPhoneData() {
  const phone = props.fieldForm[props.item.fieldName];
  const countryCode = props.fieldForm[props.item.fieldCountry];
  let countryPhone = dialCode.value + props.fieldForm[props.item.fieldName];
  props.fieldForm[props.item.countryPhone] = countryPhone;
  return {
    countryCode,
    countryPhone,
    phone,
  };
}
// 监听国家code 及 区号
watchEffect(() => {
  const newCode = props.fieldForm[props.item.fieldCountry],
    newPhone = props.fieldForm[props.item.countryPhone];
  if (newCode && newPhone) {
    const phoneNumber = parsePhoneNumber(newPhone, {
      defaultCountry: newCode,
      extract: false,
    });
    console.log('---------phoneNumber', phoneNumber)
    if (phoneNumber) {
      dialCode.value = "+" + phoneNumber.countryCallingCode
    }
  } else if (!newCode && !newPhone) {
    changeCount({
      dialCode: "86",
      iso2: "cn",
      name: "China (中国)",
      nameCN: "中国",
    }, 'init')
  }
})
function initPhone() {
  const newCode = props.fieldForm[props.item.fieldCountry],
    newPhone = props.fieldForm[props.item.countryPhone];
  if (newCode && newPhone) {
    const phoneNumber = parsePhoneNumber(newPhone, {
      defaultCountry: newCode,
      extract: false,
    });
    console.log(
      "phoneNumber****************************************",
      phoneNumber
    );
    if (phoneNumber) {
      // countryCallingCode 区号
      dialCode.value = "+" + phoneNumber.countryCallingCode.toLowerCase();
      // 有效号码 不带区号
    }
  }
  console.log('初始化', newCode, newPhone)
  if (!newCode || (newPhone && newPhone.indexOf('undefined') !== -1)) {
    changeCount({
      dialCode: "86",
      iso2: "cn",
      name: "China (中国)",
      nameCN: "中国",
    }, 'init')
  }
}
nextTick(() => {
  initPhone();
})
</script>
<style lang="scss">
@for $i from 0 through 100 {
  .boder-phone-input-#{$i} {
    border-top-right-radius: #{$i}px;
    border-bottom-right-radius: #{$i}px;

    .el-input__inner {
      border-top-right-radius: #{$i}px;
      border-bottom-right-radius: #{$i}px;
    }

    .el-input-group__prepend {
      border-top-left-radius: #{$i}px;
      border-bottom-left-radius: #{$i}px;
    }

    .vue-country-intl-input {
      border-top-left-radius: #{$i}px;
      border-bottom-left-radius: #{$i}px;
    }

    .country-intl-input {
      border-top-left-radius: #{$i}px;
      border-bottom-left-radius: #{$i}px;
    }

    .country-intl-label {
      border-top-left-radius: #{$i}px;
      border-bottom-left-radius: #{$i}px;
    }
  }
}
</style>
<style scoped lang="scss">
:deep(.country-intl-input) {
  // height: 32px;
  height: 100%;
}

:deep(.country-intl-label) {
  padding: 0 15px;
  // padding: 0 15px 0 0;
  display: flex;
  align-items: center;
  // top: 10px;
  top: 1px;
  right: 17px;
}

:deep(.vue-country-list-wrap) {
  min-width: 500px;
}

.input-with-select {
  display: flex;
}

:deep(.input-with-select .el-input-group__prepend) {
  padding: 0;
  // width: 45%;
  max-width: 110px;
  min-width: 110px;
  background-color: var(--el-fill-color-blank);
}

:deep(.input-with-select .el-input__inner) {
  padding-right: 11px;
}
.vue-country-intl-input-small {
  :deep(.vue-country-intl-input) {
    height: 32px;
  }
}

.vue-country-intl-input-default {
  :deep(.vue-country-intl-input) {
    height: 40px;
  }
}

:deep(.vue-country-intl-input .country-intl-input-wrap) {
  height: 100%;
}
</style>
```

> **组件解释说明**
>
> 当前文件是将vue-country-intl嵌入到input中，方便项目中进行配套使用，其中回显需要获取国家code
>
> 国家数据来与那：维基百科
>
> 手机号强校验规则来源：google : (强校验规则若发生更改，需要同步，参考：[libphonenumber-js](https://gitlab.com/catamphetamine/libphonenumber-js/#customizing-metadata))
>
> 回显：国家code + 区码（此格式才能回显，否则会有其他bug）
>
> 后台回传国家code及带区码手机号，带区码手机号需要分成区号及手机号
>
> 手机号校验：
>
> import parseMax from 'libphonenumber-js/max'
>
> import {isValidPhoneNumber} from "libphonenumber-js";
>
> 国内严格 国外宽松校验  
>
> 宽松校验 有问题
>
> const isPhone = isValidPhoneNumber(countryPhone, countryCode);
>
> 严格校验
>
> const maxIsPhone = parseMax(countryPhone).isValid()
>
> 配置：
>
```js

  {
    name: "手机号",
    field: "demoPhone", // 不带区号手机号 originalPhone
    fieldName: "demoPhone",
    fieldCountry: "demoCount", // 国家代码
    countryPhone: "countryPhone", // 国际手机 原手机字段
    placeholder: "请输入手机号",
    formType: "internationalPhone",
    stylePercent: "70%",
  },
    //  校验规则 必填
  demoPhone: [
      { required: true, message: "请输入手机号", trigger: ["change", "blur"] },
      {
        validator: (rule, value, callback) => {
          validatePhone(rule, value, callback, {
          countryName: 'demoCount', // 国家代码字段名
          countryPhone: 'countryPhone' // 国际手机字段名 完整手机号带区号
        },formModel);
      },
      trigger: ["change", "blur"],
    }
  ]
  // 校验手机格式 非必填时
  demoPhone: [
    { 
      required: false,  
      validator: (rule, value, callback) => {
        validatePhone(rule, value, callback, {
          countryName: 'demoCount',
          countryPhone: 'countryPhone'
        },formModel, false);
      }, 
      trigger: ["change", "blur"] 
    },
  ]
```

2. 引入其他组件中

```js
<template v-else-if="item.formType === 'internationalPhone'">
    <InternationalPhone :field-form="fieldForm" :item="item" :disabled="item.disabled || false" @phoneHandle="commonPhoneChange(item, index, $event)" />
</template>

// 国际手机
import InternationalPhone from "@RpOperations/OperationsFormItem/InternationalPhone";

```

```js
// 使用配置
{
  name: '联系电话',
  field: 'originalPhone',
  fieldName: 'originalPhone',
  placeholder: '请输入',
  formType: 'internationalPhone',
  fieldCountry: 'phoneAreaCode', // 国家代码
  width: '50%',
  countryPhone: 'phone', // 国际手机 原手机字段
},
```
